<?php

class ImageRecognize {

	/**
	* The source path of the image
	*/
	private $imgpath;

	/**
	* The information of the new image which has been clear
	*/
	public $imgsize;

	/**
	* The length of the code
	*/
	const NUM_OF_CODE = 3;

	/**
	* The index of the width which is in the result value of the build-in function getimagesize
	*/
	const IMG_WIDTH = 0;

	/**
	* The index of the height which is in the result value of the build-in function getimagesize
	*/
	const IMG_HEIGHT = 1;

	/**
	* The x-offset of the first word
	*/
	const OFFSET_X = 8;

	/*
	* The f-offset of the words
	*/
	const OFFSET_Y = 2;

	/**
	* The max width of the word
	*/
	const WORD_WIDTH = 16;
	
	/**
	* The max height of the word
	*/
	const WORD_HEIGHT = 17;

	/**
	* The distance of the each of word
	*/
	const WORD_DISTANCE = 0;

	/**
	* The references table of the words
	*/
	const REFERENCES_WORDS = [
		'0' => '000001111000000000001111110000000001110011100000000111001110000000011100111000000001110011100000000111001110000000011100111000000001110011100000000111001110000000001111110000000000011110000000000000000000000000000000000000000000000000000000',
		'1' => '000000011100000000000001110000000000001111000000000001111100000000001111110000000000110111000000000000011100000000000001110000000000000111000000000000011100000000000001110000000000000111000000000000000000000000000000000000000000000000000000',
		'2' => '000001111000000000001111110000000001110011100000000111001110000000000000111000000000000011100000000000011100000000000011100000000000011100000000000011100000000000011111111000000001111111100000000000000000000000000000000000000000000000000000',
		'3' => '000001111000000000001111110000000001110011100000000011001110000000000000111000000000001111000000000000111100000000000000111000000001110011100000000111001110000000001111110000000000011110000000000000000000000000000000000000000000000000000000',
		'4' => '000000001110000000000001111000000000001111100000000001111110000000000110111000000000110011100000000111001110000000011111111100000001111111110000000000001110000000000000111000000000000011100000000000000000000000000000000000000000000000000000',
		'5' => '000011111110000000001111111000000000110000000000000111000000000000011111100000000001111111000000000111001110000000000000111000000001110011100000000111001110000000001111110000000000011110000000000000000000000000000000000000000000000000000000',
		'6' => '000001111100000000001111111000000000110011100000000111000000000000011101100000000001111111000000000111001110000000011100111000000001110011100000000011001110000000001111110000000000011110000000000000000000000000000000000000000000000000000000',
		'7' => '000111111110000000011111111000000000000001000000000000001100000000000001100000000000000110000000000000111000000000000011100000000000001100000000000001110000000000000111000000000000011100000000000000000000000000000000000000000000000000000000',
		'8' => '000011110000000000111111000000001110011100000001110011100000001110011100000000111111000000000111111000000001110011100000001110011100000001110011100000000111111000000000011110000000000000000000000000000000000000000000000000000',
		'9' => '000001111000000000001111110000000001110011000000000111001110000000011100111000000001110011100000000011111110000000000110111000000000000011100000000111001100000000001111110000000000011110000000000000000000000000000000000000000000000000000000',
		'a' => '000000000000000000000000000000000000000000000000000001111110000000001111111100000001110001110000000000011111000000001111111100000001111001110000000111000111000000011111111100000000111101110000000000000000000000000000000000000000000000000000',
		'b' => '000111000000000000011100000000000001110000000000000111011100000000011111111000000001111001110000000111000111000000011100011100000001110001110000000111100111000000011111111000000001110111000000000000000000000000000000000000000000000000000000',
		'c' => '000000000000000000000000000000000000000000000000000001111100000000001111111000000001111001110000000111000000000000011100000000000001110000000000000111100111000000001111111000000000011111000000000000000000000000000000000000000000000000000000',
		'd' => '000000000111000000000000011100000000000001110000000001110111000000001111111100000001110011110000000111000111000000011100011100000001110001110000000111001111000000001111111100000000011101110000000000000000000000000000000000000000000000000000',
		'e' => '000000000000000000000000000000000000000000000000000001111100000000001111111000000001110001110000000111111111000000011111111100000001110000000000000111100111000000001111111000000000011111000000000000000000000000000000000000000000000000000000',
		'f' => '000011110000000000011111000000000001110000000000001111110000000000111111000000000001110000000000000111000000000000011100000000000001110000000000000111000000000000011100000000000001110000000000000000000000000000000000000000000000000000000000',
		'g' => '000000000000000000000000000000000000000000000000000001110111000000001111111100000001110011110000000111000111000000011100011100000001110001110000000111001111000000001111111100000000011101110000000000000111000000011111111000000000111111100000',
		'h' => '000111000000000000011100000000000001110000000000000111011111000000011111111110000001110001110000000111000111000000011100011100000001110001110000000111000111000000011100011100000001110001111000000000000000000000000000000000000000000000000000',
		'i' => '000111000000000000011100000000000000000000000000000111000000000000011100000000000001110000000000000111000000000000011100000000000001110000000000000111000000000000011100000000000001110000000000000000000000000000000000000000000000000000000000',
		'j' => '000111000000000000011100000000000000000000000000000111000000000000011100000000000001110000000000000111000000000000011100000000000001110000000000000111000000000000011100000000000001110000000000000111000000000001111100000000000111100000000000',
		'k' => '000111000000000000011100000000000001110000000000000111001111000000011101111000000001111111000000000111111100000000011111110000000001111011100000000111001111000000011100011100000001110001111000000000000000000000000000000000000000000000000000',
		'l' => '000111000000000000011100000000000001110000000000000111000000000000011100000000000001110000000000000111000000000000011100000000000001110000000000000111000000000000011100000000000011110000000000000000000000000000000000000000000000000000000000',
		'm' => '000000000000000000000000000000000000000000000001110111001110001111111111111001110011100111001110011100111001110011100111001110011100111001110011100111001110011100111001110011100111000000000000000000000000000000000000000000000',
		'n' => '000000000000000000000000000000000000000000000000000111011110000000011111111100000001110001110000000111000111000000011100011100000001110001110000000111000111000000011100011100000001110001110000000000000000000000000000000000000000000000000000',
		'o' => '000000000000000000000000000000000000000000000000000001111100000000001111111000000001111011110000000111000111000000011100011100000001110001110000000111101111000000001111111000000000011111000000000000000000000000000000000000000000000000000000',
		'p' => '000000000000000000000000000000000000000000000000000111011100000000011111111000000001111011110000000111000111000000011100011100000001110001110000000111100111000000011111111000000001110111000000000111000000000000011100000000000001110000000000',
		'q' => '000000000000000000000000000000000000000000000000000001110111000000001111111100000001110011110000000111000111000000011100011100000001110001110000000111001111000000001111111100000000011101110000000000000111000000000000011100000000000001110000',
		'r' => '000000000000000000000000000000000000000000000000000111011000000000011111000000000001110000000000000111000000000000011100000000000001110000000000000111000000000000011100000000000001110000000000000000000000000000000000000000000000000000000000',
		's' => '000000110000000000000000000011000000000000000000000011111100000000011100111010000001110000001000000111111000000000001111110001100000011111100000000000001110110000011100111000000000111111000000000000000000000000000000000000000000000000000000',
		't' => '000001000000000000011100000000000001110000000000001111110000000000111111000000000001110000000000000111000000000000011100000000000001110000000000000111000000000000011111000000000000111100000000000000000000000000000000000000000000000000000000',
		'u' => '000000000000000000000000000000000000000000000000000111000111000000011100011100000001110001110000000111000111000000011100011100000001110001110000000111000111000000011111111100000000111101110000000000000000000000000000000000000000000000000000',
		'v' => '000000000000000000000000000000000000000000000000001110001110000000011001110000000001110111000000000111011100000000001101100000000000110110000000000011111000000000000111000000000000111100000000000000000000000000000000000000000000000000000000',
		'w' => '000000000000000000000000000000000000000000000000011100011100011100111001110011100011100111001110001110011100111000011011011011000001111101111100000111100011110000001110001110000000110000011000000000000000000000000000000000000000000000000000',
		'x' => '000000000000000000000000000000000000000000000000001110000011100000011100011100000000111011100000000001111100000000000111110000000000111111100000000011101110000000011100011100000011100000111000000000000000000000000000000000000000000000000000',
		'y' => '000000000000000000000000000000000000000000000000001110001110000000011000111000000001110111000000000111011100000000001101110000000000110110000000000011111000000000000111100000000000011100000000000001110000000000111110000000000011111000000000',
		'z' => '000000000000000000000000000000000000000000000000000111111100000000011111110000000000001110000000000000111100000000000111000000000000111000000000000111000000000000011111110000000001111111000000000000000000000000000000000000000000000000000000'
	];

	/**
	* Pass throught the source image to the instance
	*/
	public function __construct($imgpath) {
		$this->imgpath = $imgpath;
	}

	/**
	* Recognizing the source image
	*
	* @return the string of the verification code which in the image
	*/
	public function recognize() {
		$dest = $this->imgclean();

		$dataArray = $this->imgbinary($dest);

		// $dataArray = $this->imgbinary($res);
	}

	/**
	* Clear the border of the image
	*
	* @param $border Specify the size of the border
	* @return The new image data
	*/
	public function imgclean($border = 1) {
		$dec = $border + 1;

		// Give the information of the source image
		$size = getimagesize($this->imgpath);
		$res = imagecreatefromjpeg($this->imgpath);
		// Create the new image without the border
		$imgwidth = $size[self::IMG_WIDTH] - $dec;
		$imgheight = $size[self::IMG_HEIGHT] - $dec;

		$dest = imagecreatetruecolor($imgwidth, $imgheight);
		imagecopy($dest, $res, 0, 0, $border, $border, $imgwidth, $imgheight);
		// imagecopy($dest, $res, 0, 0, self::OFFSET_X, $border, self::WORD_WIDTH, $size[self::IMG_HEIGHT] - $dec);
		// $this->imgsize[self::IMG_WIDTH] = self::WORD_WIDTH;
		$this->imgsize[self::IMG_WIDTH] = $imgwidth;
		$this->imgsize[self::IMG_HEIGHT] = $imgheight;

		return $dest;
	}

	/**
	* Clear the background color and the interferential pixel of the image
	*
	* @return the two-dimension array data which has the filter data
	*/
	public function imgbinary($image) {
		$data = [];
		for($i = 0; $i < $this->imgsize[self::IMG_HEIGHT]; ++$i)
		{
			for($j = 0; $j < $this->imgsize[self::IMG_WIDTH]; ++$j)
			{
				$rgb = imagecolorat($image, $j, $i);
				$rgbarray = imagecolorsforindex($image, $rgb);

				if($rgbarray['red'] > 200 || $rgbarray['green'] > 200 || $rgbarray['blue'] > 200)
				{
					$data[$i][$j] = 0;
				} else {
					$data[$i][$j] = 1;
				}
			}
		}

		// Clear the interferential pixel
		for($i = 0; $i < $this->imgsize[self::IMG_HEIGHT]; ++$i)
		{
			for($j = 0; $j < $this->imgsize[self::IMG_WIDTH]; ++$j)
			{
				$channel = 0;
				if ($data[$i][$j] == 1) {
				 	// Top
				 	if(isset($data[$i - 1][$j])){
						$channel = $channel + $data[$i - 1][$j];
					}
					// Bottom
					if(isset($data[$i + 1][$j])){
						$channel = $channel + $data[$i + 1][$j];
					}
					// Left
					if(isset($data[$i][$j - 1])){
						$channel = $channel + $data[$i][$j - 1];
					}
					// Right
					if(isset($data[$i][$j + 1])){
						$channel = $channel + $data[$i][$j + 1];
					}
					if($channel == 0){
						$data[$i][$j] = 0;
					}
				}
			}
		}

		return $data;
	}


	/**
	* Find out the each of the element in the filter data
	*/
	public function imgmatch($dataArray) {
		// split the image
		for ($i = 0; $i < self::NUM_OF_CODE; $i++) { 
			
		}
	}

}